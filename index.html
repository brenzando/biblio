<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BiblioSys - EEMTI Profa. Adalgisa Bonfim Soares</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
    rel="stylesheet"
  />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  
  <style>
    :root {
      --primary: #10b981; /* Emerald 500 */
      --primary-dark: #059669; /* Emerald 600 */
      --secondary: #f59e0b; /* Amber 500 */
      --accent: #f97316; /* Orange 500 */
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
    }
    body {
      font-family: "Inter", sans-serif;
      background: linear-gradient(135deg, #111827 0%, #1f2937 100%);
      color: #9ca3af;
      min-height: 100vh;
      transition: all 0.3s ease;
      margin: 0;
      padding: 1rem;
    }
    h1, h2, h3, h4, .font-bold { color: #f9fafb; }
    .glass-effect {
      background: rgba(31, 41, 55, 0.4); /* Gray 800 */
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .card-hover { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .card-hover:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
      background: rgba(31, 41, 55, 0.7);
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      transition: all 0.3s ease;
      cursor: pointer;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(16, 185, 129, 0.4);
    }
    .nav-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      border-radius: 12px;
      color: #d1d5db;
      transition: all 0.3s ease;
      cursor: pointer;
      user-select: none;
    }
    .nav-item:hover {
      background: rgba(16, 185, 129, 0.1);
      color: white;
    }
    .nav-item.active {
      background: rgba(16, 185, 129, 0.2);
      color: white;
      font-weight: 600;
      border-left: 4px solid var(--primary);
    }
    .nav-item-content {
      display: flex;
      align-items: center;
    }
    .nav-item i {
      margin-right: 12px;
      width: 20px;
      text-align: center;
    }
    .action-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      border-radius: 16px;
      transition: all 0.3s ease;
      cursor: pointer;
      border: 1px solid rgba(255, 255, 255, 0.1);
      user-select: none;
      color: #d1d5db;
      font-weight: 500;
      background-color: rgba(31, 41, 55, 0.4);
    }
    .action-btn:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
      background-color: rgba(31, 41, 55, 0.8);
    }
    .form-input, .form-select {
      background: rgba(17, 24, 39, 0.5); /* Gray 900 */
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: #e5e7eb;
      transition: all 0.3s ease;
      border-radius: 0.5rem;
      padding: 0.75rem 1rem;
      width: 100%;
    }
    .form-input::placeholder { color: #9ca3af; }
    .form-input:focus, .form-select:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.4);
      border-color: var(--primary);
    }
    .form-select {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 0.5rem center;
      background-repeat: no-repeat;
      background-size: 1.5em 1.5em;
      padding-right: 2.5rem;
    }
    .badge {
      display: inline-block;
      padding: 0.25em 0.6em;
      font-size: 75%;
      font-weight: 700;
      line-height: 1;
      text-align: center;
      white-space: nowrap;
      vertical-align: baseline;
      border-radius: 0.375rem;
    }
    main::-webkit-scrollbar, .modal-body::-webkit-scrollbar { width: 8px; }
    main::-webkit-scrollbar-track, .modal-body::-webkit-scrollbar-track { background: transparent; }
    main::-webkit-scrollbar-thumb, .modal-body::-webkit-scrollbar-thumb {
      background-color: rgba(16, 185, 129, 0.4);
      border-radius: 4px;
    }
    main::-webkit-scrollbar-thumb:hover, .modal-body::-webkit-scrollbar-thumb:hover { background-color: rgba(16, 185, 129, 0.6); }
  </style>
</head>
<body class="text-gray-300">

  <div id="loginScreen" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900">
      <div class="w-full max-w-md">
          <form id="loginForm" class="glass-effect rounded-2xl p-8 space-y-6">
              <div class="text-center">
                  <i class="fas fa-book-open text-4xl" style="background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;"></i>
                  <h1 class="text-3xl font-bold text-white mt-2">BiblioSys</h1>
                  <p>EEMTI Profa. Adalgisa Bonfim Soares</p>
              </div>
              <div>
                  <label for="email" class="block mb-2 text-sm font-medium text-white">E-mail</label>
                  <input type="email" id="email" class="form-input" placeholder="seuemail@exemplo.com" required>
              </div>
              <div>
                  <label for="password" class="block mb-2 text-sm font-medium text-white">Senha</label>
                  <input type="password" id="password" class="form-input" placeholder="••••••••" required>
              </div>
              <p id="loginError" class="text-red-400 text-sm text-center hidden">E-mail ou senha inválidos.</p>
              <button type="submit" class="w-full btn-primary text-white font-bold py-3 px-4 rounded-lg">Entrar</button>
              <div class="text-xs text-center text-gray-400 pt-4">
                  <p>Use: <span class="font-mono">admin@bibliosys.com / 123456</span> (Acesso Total)</p>
                  <p>Use: <span class="font-mono">professor@bibliosys.com / prof123</span> (Acesso Professor)</p>
                  <p>Use: <span class="font-mono">leitor@bibliosys.com / 1234</span> (Apenas Visualização)</p>
              </div>
          </form>
      </div>
  </div>

  <div id="appContainer" class="w-full max-w-7xl mx-auto hidden">
    <header
      class="glass-effect rounded-2xl p-6 mb-6 flex items-center justify-between"
    >
      <div class="flex items-center space-x-4">
        <div
          class="w-12 h-12 bg-gray-900 rounded-xl flex items-center justify-center"
        >
          <i
            class="fas fa-book-open text-xl"
            style="
              background: linear-gradient(135deg, var(--primary), var(--secondary));
              -webkit-background-clip: text;
              -webkit-text-fill-color: transparent;
            "
          ></i>
        </div>
        <div>
           <h1 class="text-2xl font-bold text-white">BiblioSys</h1>
           <p class="text-xs -mt-1">EEMTI Profa. Adalgisa Bonfim Soares</p>
           <p id="welcomeMessage" class="text-sm mt-2"></p>
        </div>
      </div>

      <div class="flex items-center space-x-6">
         <button id="notificationBtn" title="Notificações" class="text-gray-300 hover:text-white transition-colors relative">
           <i class="fas fa-bell text-2xl"></i>
           <span id="notificationIndicator" class="absolute top-0 right-0 block h-2 w-2 rounded-full bg-red-500 hidden"></span>
        </button>
        <div class="relative">
          <input
            type="text"
            placeholder="Buscar no acervo..."
            class="form-input"
            id="searchInput"
          />
          <i
            class="fas fa-search absolute right-3 top-1/2 -translate-y-1/2 text-white/60 pointer-events-none"
          ></i>
        </div>
         <button id="logoutBtn" title="Sair do Sistema" class="text-red-400 hover:text-red-300 transition-colors">
           <i class="fas fa-sign-out-alt text-2xl"></i>
        </button>
      </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
      <aside class="lg:col-span-1 glass-effect rounded-2xl p-6">
        <nav class="space-y-2" id="sidebarNav">
          <a href="#" class="nav-item active" data-section="dashboard">
            <div class="nav-item-content">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </div>
          </a>
          <a href="#" class="nav-item" data-section="acervo">
            <div class="nav-item-content">
                <i class="fas fa-book-bookmark"></i>
                <span>Acervo</span>
            </div>
          </a>
          <a href="#" class="nav-item" data-section="reservas">
            <div class="nav-item-content">
                <i class="fas fa-calendar-check"></i>
                <span>Reservas</span>
            </div>
            <span id="reservasIndicator" class="badge bg-amber-500 text-white"></span>
          </a>
          <a href="#" class="nav-item" data-section="emprestimos">
            <div class="nav-item-content">
                <i class="fas fa-exchange-alt"></i>
                <span>Empréstimos</span>
            </div>
          </a>
          <a href="#" class="nav-item" data-section="usuarios">
            <div class="nav-item-content">
                <i class="fas fa-users"></i>
                <span>Usuários</span>
            </div>
          </a>
          <a href="#" class="nav-item" data-section="relatorios">
            <div class="nav-item-content">
                <i class="fas fa-chart-line"></i>
                <span>Relatórios</span>
            </div>
          </a>
          <a href="#" class="nav-item" data-section="configuracoes">
            <div class="nav-item-content">
                <i class="fas fa-cog"></i>
                <span>Configurações</span>
            </div>
          </a>
        </nav>

        <div id="statusBlock" class="mt-8 p-4 bg-gray-900/40 rounded-lg text-white">
          <h3 class="font-semibold mb-2">Status do Sistema</h3>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span>Itens no Acervo</span>
              <span id="totalItems" class="font-semibold">0</span>
            </div>
             <div class="flex justify-between">
              <span>Exemplares Totais</span>
              <span id="totalCopies" class="font-semibold">0</span>
            </div>
            <div class="flex justify-between">
              <span>Usuários cadastrados</span>
              <span id="totalUsers" class="font-semibold">0</span>
            </div>
            <div class="flex justify-between">
              <span>Empréstimos Ativos</span>
              <span id="totalLoans" class="font-semibold">0</span>
            </div>
          </div>
        </div>
      </aside>

      <main class="lg:col-span-3 space-y-6" id="mainContent">
        <section id="dashboard" class="tab-content active">
            <h2 class="text-2xl font-semibold mb-4">Dashboard</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="glass-effect rounded-xl p-6 text-white card-hover">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm opacity-80">Itens no Acervo</p>
                  <p class="text-2xl font-bold" id="dashboardItems">0</p>
                </div>
                <i class="fas fa-book-bookmark text-2xl opacity-70"></i>
              </div>
            </div>
            <div class="glass-effect rounded-xl p-6 text-white card-hover">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm opacity-80">Empréstimos Ativos</p>
                  <p class="text-2xl font-bold" id="dashboardLoans">0</p>
                </div>
                <i class="fas fa-exchange-alt text-2xl opacity-70"></i>
              </div>
            </div>
            <div class="glass-effect rounded-xl p-6 text-white card-hover">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm opacity-80">Usuários</p>
                  <p class="text-2xl font-bold" id="dashboardUsers">0</p>
                </div>
                <i class="fas fa-users text-2xl opacity-70"></i>
              </div>
            </div>
            <div class="glass-effect rounded-xl p-6 text-white card-hover">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm opacity-80">Atrasados</p>
                  <p class="text-2xl font-bold" id="dashboardOverdue">0</p>
                </div>
                <i class="fas fa-hourglass-half text-2xl opacity-70"></i>
              </div>
            </div>
          </div>
          <div id="quickActionsBlock" class="glass-effect rounded-2xl p-6 mt-6">
            <h2 class="text-xl font-semibold mb-6">Ações Rápidas</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
              <button class="action-btn" id="btnAddItem" title="Adicionar novo item ao acervo"><i class="fas fa-plus-circle text-2xl text-emerald-400"></i><span>Novo Item</span></button>
              <button class="action-btn" id="btnAddLoan" title="Registrar novo empréstimo"><i class="fas fa-hand-holding-usd text-2xl text-emerald-400"></i><span>Novo Empréstimo</span></button>
              <button class="action-btn" id="btnAddUser" title="Adicionar novo usuário"><i class="fas fa-user-plus text-2xl text-amber-400"></i><span>Novo Usuário</span></button>
              <button class="action-btn" id="btnViewReports" title="Visualizar relatórios"><i class="fas fa-chart-line text-2xl text-orange-400"></i><span>Relatórios</span></button>
            </div>
          </div>
        </section>

        <section id="acervo" class="tab-content hidden">
          <h2 class="text-2xl font-semibold mb-4">Acervo da Biblioteca</h2>
          <div id="itemList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </section>

        <section id="reservas" class="tab-content hidden">
            <h2 class="text-2xl font-semibold mb-4">Gerenciamento de Reservas</h2>
            <div id="reservationList" class="space-y-4"></div>
        </section>

        <section id="emprestimos" class="tab-content hidden">
          <h2 class="text-2xl font-semibold mb-4">Empréstimos Ativos</h2>
          <div id="loanList" class="space-y-4"></div>
        </section>

        <section id="usuarios" class="tab-content hidden">
          <h2 class="text-2xl font-semibold mb-4">Gestão de Usuários</h2>
          <div id="userList" class="space-y-4"></div>
        </section>

        <section id="relatorios" class="tab-content hidden">
            <div class="flex justify-between items-center mb-4">
                 <h2 class="text-2xl font-semibold">Relatórios e Estatísticas</h2>
                 <button id="btnDownloadReport" class="btn-primary text-white font-bold py-2 px-4 rounded-lg"><i class="fas fa-file-pdf mr-2"></i>Baixar Relatório</button>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="glass-effect rounded-2xl p-6">
                    <h3 class="text-xl font-semibold mb-4">Itens Mais Emprestados</h3>
                    <div id="mostLoanedList" class="space-y-3"></div>
                </div>
                <div class="glass-effect rounded-2xl p-6">
                    <h3 class="text-xl font-semibold mb-4">Classificações Mais Emprestadas</h3>
                    <div id="mostLoanedClassificationsList" class="space-y-3"></div>
                </div>
                <div class="glass-effect rounded-2xl p-6">
                    <h3 class="text-xl font-semibold mb-4">Leitores Mais Ativos</h3>
                    <div id="mostActiveReadersList" class="space-y-3"></div>
                </div>
                <div class="glass-effect rounded-2xl p-6">
                    <h3 class="text-xl font-semibold mb-4">Ranking de Turmas/Séries</h3>
                    <div id="mostActiveClassesList" class="space-y-3"></div>
                </div>
                <div class="glass-effect rounded-2xl p-6 flex flex-col items-center justify-center lg:col-span-2">
                    <h3 class="text-xl font-semibold mb-4">Mês de Maior Atividade</h3>
                    <div id="loanActivityStats" class="text-center"></div>
                </div>
            </div>
        </section>

        <section id="configuracoes" class="tab-content hidden">
          <h2 class="text-2xl font-semibold mb-4">Configurações do Sistema</h2>
           <div class="glass-effect rounded-2xl p-6 space-y-6">
             <div>
               <h3 class="text-xl font-semibold mb-4">Funcionalidades Extras</h3>
               <div class="space-y-4">
                   <div class="flex items-center justify-between p-3 bg-gray-900/40 rounded-lg">
                       <label for="rfidToggle" class="font-medium text-white">Habilitar Suporte a RFID</label>
                       <input type="checkbox" id="rfidToggle" class="form-checkbox h-5 w-5 text-emerald-500 rounded focus:ring-emerald-400 bg-slate-700 border-slate-600" checked>
                   </div>
                   <div class="flex items-center justify-between p-3 bg-gray-900/40 rounded-lg">
                       <label for="moodleToggle" class="font-medium text-white">Integração com Moodle</label>
                       <input type="checkbox" id="moodleToggle" class="form-checkbox h-5 w-5 text-emerald-500 rounded focus:ring-emerald-400 bg-slate-700 border-slate-600">
                   </div>
                    <div class="flex items-center justify-between p-3 bg-gray-900/40 rounded-lg">
                       <label for="recommendationToggle" class="font-medium text-white">Recomendações Personalizadas</label>
                       <input type="checkbox" id="recommendationToggle" class="form-checkbox h-5 w-5 text-emerald-500 rounded focus:ring-emerald-400 bg-slate-700 border-slate-600" checked>
                   </div>
               </div>
             </div>
             <div>
               <h3 class="text-xl font-semibold mb-4">Backup e Restauração</h3>
                <div class="flex space-x-4">
                  <button class="btn-primary text-white font-bold py-2 px-4 rounded-lg"><i class="fas fa-download mr-2"></i>Fazer Backup</button>
                  <button class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-4 rounded-lg"><i class="fas fa-upload mr-2"></i>Restaurar Dados</button>
                </div>
             </div>
           </div>
        </section>
      </main>
    </div>
  </div>

  <div id="modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50">
    <div id="modalContainer" class="bg-gray-900 border border-gray-700 text-gray-200 rounded-2xl max-w-lg w-full relative shadow-2xl flex flex-col">
      <header class="p-6 border-b border-gray-700 flex justify-between items-center">
        <h3 id="modalTitle" class="text-xl font-semibold text-white"></h3>
        <button id="modalClose" class="text-gray-400 hover:text-white" aria-label="Fechar modal"><i class="fas fa-times text-xl"></i></button>
      </header>
      <div id="modalContent" class="p-6 overflow-y-auto modal-body" style="max-height: 70vh;"></div>
    </div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    // --- INICIALIZAÇÃO DO FIREBASE (ESPECÍFICO PARA O SEU PROJETO) ---
    // ATENÇÃO: PREENCHA OS CAMPOS COM AS CHAVES DO SEU PROJETO NO CONSOLE DO FIREBASE
    const firebaseConfig = {
      apiKey: "AIzaSyAldbXy5UKnrad3_oQJLmrUaNNJhD43F98",
      authDomain: "bibliosys-f2c30.firebaseapp.com",
      projectId: "bibliosys-f2c30",
      storageBucket: "bibliosys-f2c30.appspot.com",
      messagingSenderId: "454174949267",
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const firestore = firebase.firestore();

    // --- STATE MANAGEMENT ---
    let currentUser = null;
    let reportDataCache = {}; // Mantém dados para geração de PDF
    
    // --- LÓGICA DE AUTENTICAÇÃO COM FIREBASE ---
    
    // Observador do estado de autenticação: a função mais importante!
    auth.onAuthStateChanged(user => {
        if (user) {
            // Usuário está logado
            firestore.collection('users').doc(user.uid).get().then(doc => {
                if (doc.exists) {
                    currentUser = { id: user.uid, email: user.email, ...doc.data() };
                    initAppUI(); // Inicia a interface principal do app
                } else {
                    console.error("Dados do usuário não encontrados no Firestore!");
                    handleLogout(); // Força o logout se não houver perfil
                }
            }).catch(error => {
                console.error("Erro ao buscar dados do usuário: ", error);
                handleLogout();
            });
        } else {
            // Usuário está deslogado
            currentUser = null;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('appContainer').classList.add('hidden');
        }
    });

    function handleLogin(e) {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const loginError = document.getElementById('loginError');

        auth.signInWithEmailAndPassword(email, password)
            .then((userCredential) => {
                // Sucesso! O onAuthStateChanged vai cuidar do resto.
                loginError.classList.add('hidden');
            })
            .catch((error) => {
                console.error("Erro de login:", error.message);
                loginError.textContent = "E-mail ou senha inválidos.";
                loginError.classList.remove('hidden');
            });
    }

    function handleLogout() {
        auth.signOut().catch(error => console.error("Erro ao sair:", error));
    }
    
    function initAppUI() {
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('appContainer').classList.remove('hidden');
        applyRolePermissions();
        updateAll();
        switchTab('dashboard');
        // updateNotificationIndicator(); // Implementar com Firestore
    }

    // A função de permissões permanece similar, usando currentUser.role
    function applyRolePermissions() {
        if (!currentUser) return;
        document.getElementById('welcomeMessage').textContent = `Bem-vindo(a), ${currentUser.name}!`;
        
        const navItems = document.querySelectorAll('.nav-item');
        const quickActionsBlock = document.getElementById('quickActionsBlock');
        const statusBlock = document.getElementById('statusBlock');
        
        const allSections = ['dashboard', 'acervo', 'reservas', 'emprestimos', 'usuarios', 'relatorios', 'configuracoes'];
        let allowedSections = [];
        
        quickActionsBlock.style.display = 'grid'; // usa grid
        statusBlock.style.display = 'block';
        
        switch (currentUser.role) {
            case 'Admin':
                allowedSections = allSections;
                break;
            case 'Professor(a)':
                allowedSections = ['dashboard', 'acervo', 'relatorios'];
                quickActionsBlock.style.display = 'none';
                break;
            case 'Leitor(a)':
                allowedSections = ['acervo'];
                quickActionsBlock.style.display = 'none';
                statusBlock.style.display = 'none';
                break;
        }

        navItems.forEach(item => {
            const section = item.dataset.section;
            if (allowedSections.includes(section)) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    }

    // --- FUNÇÕES DE RENDERIZAÇÃO COM FIRESTORE (TEMPO REAL) ---

    function updateCounters() {
        // Contar itens no acervo
        firestore.collection('items').onSnapshot(snapshot => {
            const count = snapshot.size;
            document.getElementById("totalItems").textContent = count;
            document.getElementById("dashboardItems").textContent = count;
        });
        
        // Contar exemplares
        firestore.collection('copies').onSnapshot(snapshot => {
            document.getElementById("totalCopies").textContent = snapshot.size;
        });

        // Contar usuários
        firestore.collection('users').onSnapshot(snapshot => {
            const count = snapshot.size;
            document.getElementById("totalUsers").textContent = count;
            document.getElementById("dashboardUsers").textContent = count;
        });

        // Contar empréstimos ativos e atrasados
        firestore.collection('loans').where('returnDate', '==', null).onSnapshot(snapshot => {
            const activeLoans = snapshot.docs;
            const today = new Date().toISOString().split('T')[0];
            const overdueCount = activeLoans.filter(doc => doc.data().dueDate < today).length;
            
            document.getElementById("totalLoans").textContent = activeLoans.length;
            document.getElementById("dashboardLoans").textContent = activeLoans.length;
            document.getElementById("dashboardOverdue").textContent = overdueCount;
        });

        // Contar reservas pendentes
        firestore.collection('reservations').where('status', '==', 'Pendente').onSnapshot(snapshot => {
            const pendingCount = snapshot.size;
            const reservasIndicator = document.getElementById('reservasIndicator');
            if (pendingCount > 0) {
                reservasIndicator.textContent = pendingCount;
                reservasIndicator.style.display = 'inline-block';
            } else {
                reservasIndicator.style.display = 'none';
            }
        });
    }

    async function renderAcervo(filter = "") {
        const container = document.getElementById("itemList");
        container.innerHTML = "Carregando acervo...";

        try {
            const itemsSnapshot = await firestore.collection('items').get();
            const copiesSnapshot = await firestore.collection('copies').get();

            const copiesByItemId = {};
            copiesSnapshot.forEach(doc => {
                const copy = doc.data();
                if (!copiesByItemId[copy.itemId]) {
                    copiesByItemId[copy.itemId] = [];
                }
                copiesByItemId[copy.itemId].push(copy);
            });

            let allItems = [];
            itemsSnapshot.forEach(doc => {
                allItems.push({ id: doc.id, ...doc.data() });
            });

            const lowercasedFilter = filter.toLowerCase();
            const filteredItems = allItems.filter(item =>
              item.title.toLowerCase().includes(lowercasedFilter) ||
              item.author.toLowerCase().includes(lowercasedFilter) ||
              (item.isbn_issn && item.isbn_issn.toLowerCase().includes(lowercasedFilter))
            );
            
            container.innerHTML = "";
            if (filteredItems.length === 0) {
                container.innerHTML = `<p class="text-center md:col-span-2 lg:col-span-3">Nenhum item encontrado.</p>`;
                return;
            }

            filteredItems.forEach((item) => {
                const itemCopies = copiesByItemId[item.id] || [];
                const availableCopies = itemCopies.filter(c => c.status === "Disponível").length;
                const typeIcons = { 'Livro': 'fa-book', 'Revista': 'fa-newspaper', 'Mídia Digital': 'fa-compact-disc' };

                const card = `
                  <div class="glass-effect rounded-xl p-4 flex flex-col justify-between card-hover cursor-pointer" onclick="showItemDetailsModal('${item.id}')">
                    <div>
                      <div class="flex justify-between items-start">
                          <h3 class="font-bold text-lg text-white mb-1">${item.title}</h3>
                          <span class="badge bg-emerald-500/30 text-emerald-300"><i class="fas ${typeIcons[item.type] || 'fa-question-circle'} mr-1"></i>${item.type}</span>
                      </div>
                      <p class="text-sm text-gray-400 mb-2">${item.author}</p>
                    </div>
                    <div class="flex justify-between items-center mt-4 pt-2 border-t border-gray-700">
                      <span class="text-sm font-semibold ${availableCopies > 0 ? 'text-green-400' : 'text-yellow-400'}">
                          ${availableCopies} de ${itemCopies.length} disponível(is)
                      </span>
                      <span class="text-sm text-emerald-400 hover:text-emerald-300">Ver detalhes <i class="fas fa-arrow-right"></i></span>
                    </div>
                  </div>`;
                container.innerHTML += card;
            });

        } catch (error) {
            console.error("Erro ao renderizar acervo: ", error);
            container.innerHTML = `<p class="text-center md:col-span-2 lg:col-span-3 text-red-400">Erro ao carregar o acervo.</p>`;
        }
    }
    
    // As outras funções de renderização (loans, users, etc.) seguiriam um padrão similar de fetch com .get() ou .onSnapshot().

    // --- AÇÕES CRUD COM FIRESTORE ---
    
    // Exemplo de como uma função de deleção seria:
    window.deleteItem = (itemId) => {
        if (!confirm('Tem certeza que deseja excluir este item? TODOS os seus exemplares e registros associados serão removidos.')) return;

        const batch = firestore.batch();
        
        // Deletar o item principal
        const itemRef = firestore.collection('items').doc(itemId);
        batch.delete(itemRef);

        // Encontrar e deletar exemplares associados
        firestore.collection('copies').where('itemId', '==', itemId).get()
            .then(snapshot => {
                snapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                return batch.commit();
            })
            .then(() => {
                alert('Item e seus exemplares foram removidos.');
                // A UI se atualizará automaticamente se estiver usando onSnapshot
                // Se não, chame renderAcervo() novamente.
                closeModal();
            })
            .catch(error => console.error("Erro ao deletar item em lote: ", error));
    };

    // A lógica para as outras funções (add, update) seguiria o mesmo padrão:
    // 1. Pegar dados do formulário
    // 2. Chamar a função apropriada do Firestore (add, doc().update(), etc.)
    // 3. Usar .then() para sucesso e .catch() para erros.


    // --- MODAIS (LÓGICA INTERNA MODIFICADA) ---
    // Abertura do modal é igual, mas a submissão dos formulários agora usa Firestore.

    function showAddItemModal() {
        // ... (código para gerar o HTML do formulário do modal é o mesmo)
        const content = `
            <form id="addItemForm" class="space-y-4">
              <div class="grid grid-cols-2 gap-4">
                <input type="text" id="itemTitle" placeholder="Título" class="form-input col-span-2" required>
                <input type="text" id="itemAuthor" placeholder="Autor/Artista" class="form-input" required>
                <select id="itemType" class="form-select" required><option value="Livro">Livro</option><option value="Revista">Revista</option><option value="Mídia Digital">Mídia Digital</option></select>
                <input type="text" id="itemPublisher" placeholder="Editora" class="form-input">
                <input type="number" id="itemYear" placeholder="Ano" class="form-input">
                <input type="text" id="itemIsbn" placeholder="ISBN/ISSN" class="form-input col-span-2" required>
                <input type="text" id="itemClassification" placeholder="Classificação (Ex: Fantasia)" class="form-input">
                <input type="text" id="itemLocation" placeholder="Localização (Ex: Corredor A)" class="form-input">
              </div>
              <div class="pt-4 border-t border-gray-700">
                <label for="itemQuantity" class="block mb-2 font-semibold">Quantidade de exemplares a criar:</label>
                <input type="number" id="itemQuantity" value="1" min="1" class="form-input w-full">
              </div>
              <button type="submit" class="w-full btn-primary text-white font-bold py-3 px-4 rounded-lg">Adicionar Item</button>
            </form>`;
        showModal("Adicionar Novo Item ao Acervo", content, 'max-w-3xl');
        
        document.getElementById("addItemForm").onsubmit = e => {
            e.preventDefault();
            const newItemData = {
                title: document.getElementById("itemTitle").value,
                author: document.getElementById("itemAuthor").value,
                type: document.getElementById("itemType").value,
                publisher: document.getElementById("itemPublisher").value,
                year: Number(document.getElementById("itemYear").value),
                isbn_issn: document.getElementById("itemIsbn").value,
                classification: document.getElementById("itemClassification").value,
                location: document.getElementById("itemLocation").value,
                recommendedBy: null // Simplificado
            };

            firestore.collection("items").add(newItemData)
                .then(docRef => {
                    const itemId = docRef.id;
                    const quantity = parseInt(document.getElementById("itemQuantity").value) || 1;
                    const batch = firestore.batch();
                    const typePrefix = newItemData.type.substring(0,3).toUpperCase();

                    for(let i = 0; i < quantity; i++) {
                        const copyRef = firestore.collection("copies").doc(); // Gera um ID automático
                        batch.set(copyRef, {
                            itemId: itemId,
                            barcode: `${typePrefix}${Date.now() + i}`,
                            status: "Disponível"
                        });
                    }
                    return batch.commit();
                })
                .then(() => {
                    alert("Item e exemplares adicionados com sucesso!");
                    closeModal();
                })
                .catch(error => {
                    console.error("Erro ao adicionar item: ", error);
                    alert("Falha ao adicionar o item.");
                });
        };
    }
    
    // As outras funções de modal (addLoan, addUser, etc) precisam de refatoração similar
    // para usar o Firestore em seus formulários de submissão.
    
    window.showItemDetailsModal = async (itemId) => {
      try {
        const itemDoc = await firestore.collection('items').doc(itemId).get();
        if (!itemDoc.exists) return;
        const item = { id: itemDoc.id, ...itemDoc.data() };

        const copiesSnapshot = await firestore.collection('copies').where('itemId', '==', itemId).get();
        const copies = copiesSnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
        
        // ... (resto do código para gerar o HTML do modal é o mesmo, usando os dados `item` e `copies`)
        const statusStyles = { 'Disponível': 'bg-green-500/30 text-green-300', 'Emprestado': 'bg-yellow-500/30 text-yellow-300', 'Danificado': 'bg-red-500/30 text-red-300', 'Extraviado': 'bg-gray-500/30 text-gray-300', 'Reservado': 'bg-blue-500/30 text-blue-300' };
        let copiesHtml = copies.map(copy => `<li class="flex justify-between items-center p-2 bg-gray-800 rounded-md"><div><span class="font-mono text-sm">#${copy.barcode}</span></div><span class="badge ${statusStyles[copy.status] || ''}">${copy.status}</span></li>`).join('');

        let actionButtons = '';
        if (currentUser.role === 'Admin') {
            actionButtons = `
              <div class="mt-6 pt-4 border-t border-gray-700 flex justify-end space-x-4">
                  <button class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg" onclick="showEditItemModal('${itemId}')">Editar Item</button>
                  <button class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg" onclick="deleteItem('${itemId}')">Excluir Item</button>
              </div>`;
        }
        
        const content = `<div class="space-y-4"><div><h4 class="font-bold text-white">${item.title}</h4><p class="text-sm text-gray-400">${item.author} (${item.year})</p></div><div class="text-sm space-y-2 p-3 bg-gray-800/50 rounded-lg"><p><strong>Editora:</strong> ${item.publisher}</p><p><strong>ISBN/ISSN:</strong> ${item.isbn_issn}</p><p><strong>Classificação:</strong> ${item.classification}</p><p><strong>Localização:</strong> ${item.location}</p></div><div><h4 class="font-bold text-white mb-2">Exemplares (${copies.length})</h4><ul class="space-y-2">${copiesHtml}</ul></div>${actionButtons}</div>`;
        showModal("Detalhes do Item", content, 'max-w-2xl');

      } catch(error) {
        console.error("Erro ao mostrar detalhes do item:", error);
      }
    }


    // --- FUNÇÕES GERAIS E DE NAVEGAÇÃO (A MAIORIA PERMANECE IGUAL) ---
    
    const modal = document.getElementById("modal");
    const modalContainer = document.getElementById("modalContainer");
    const modalTitle = document.getElementById("modalTitle");
    const modalContent = document.getElementById("modalContent");
    const modalClose = document.getElementById("modalClose");
    
    function showModal(title, content, size = 'max-w-lg') {
        modalTitle.innerText = title;
        modalContent.innerHTML = content;
        modalContainer.className = modalContainer.className.replace(/max-w-\w+/g, size);
        modal.classList.remove("hidden");
    }

    function closeModal() { modal.classList.add("hidden"); }
    modalClose.onclick = closeModal;
    modal.onclick = (e) => { if (e.target === modal) closeModal(); };

    function updateAll() {
        if (!currentUser) return;
        updateCounters();
        const activeTab = document.querySelector(".nav-item.active")?.dataset.section || 'dashboard';
        // As funções de renderização serão chamadas dentro do switchTab
        switchTab(activeTab, false); 
    }

    function switchTab(sectionId, changeHistory = true) {
        // ... (lógica de permissão e troca de aba é a mesma)
        if (changeHistory) {
            document.querySelectorAll(".nav-item").forEach(n => n.classList.remove("active"));
            const newActive = document.querySelector(`.nav-item[data-section="${sectionId}"]`);
            if (newActive) newActive.classList.add("active");
        }
        document.querySelectorAll(".tab-content").forEach(s => s.classList.add("hidden"));
        document.getElementById(sectionId)?.classList.remove("hidden");
        
        // Chama a função de renderização apropriada para a aba
        if (sectionId === 'acervo') renderAcervo();
        // if (sectionId === 'reservas') renderReservations(); // Implementar
        // if (sectionId === 'emprestimos') renderLoans(); // Implementar
        // if (sectionId === 'usuarios') renderUsers(); // Implementar
        // if (sectionId === 'relatorios') renderReports(); // Implementar
    }


    // --- EVENT LISTENERS ---
    
    document.getElementById("loginForm").addEventListener('submit', handleLogin);
    document.getElementById("logoutBtn").addEventListener('click', handleLogout);

    document.getElementById("sidebarNav").addEventListener("click", (e) => {
        const navItem = e.target.closest(".nav-item");
        if (navItem) { e.preventDefault(); switchTab(navItem.dataset.section); }
    });
    
    document.getElementById("searchInput").addEventListener("input", (e) => {
        switchTab('acervo'); 
        renderAcervo(e.target.value);
    });

    document.getElementById("btnAddItem").onclick = showAddItemModal;
    // document.getElementById("btnAddLoan").onclick = showAddLoanModal; // Implementar
    // document.getElementById("btnAddUser").onclick = showAddUserModal; // Implementar
    document.getElementById("btnViewReports").onclick = () => switchTab('relatorios');

});
</script>

</body>
</html>
